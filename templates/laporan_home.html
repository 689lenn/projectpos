{% extends "base.html" %}
{% block title %}Laporan & Analitik{% endblock %}

{% block head %}
<style>
  :root{
    --card:#fff; --border:#e6e8f0; --muted:#6b7280; --text:#111827;
    --brand:#007bff; --brand-hover:#0064cf; --ring: rgba(0,123,255,.25);
    --radius:12px; --shadow:0 10px 25px rgba(0,0,0,.06);
    --ok:#16a34a; --danger:#ef4444; --info:#0ea5e9;
  }
  .wrap{ display:grid; grid-template-columns: 220px 1fr; gap:14px; }
  @media (max-width: 900px){ .wrap{ grid-template-columns: 1fr; } }

  .panel{
    background:var(--card); border:1px solid var(--border);
    border-radius:var(--radius); box-shadow: var(--shadow);
  }
  .menu{ padding:12px; }
  .menu h3{ margin:0 0 8px; font-size:15px; color:#374151; }
  .menu a{
    display:block; padding:10px 12px; border-radius:10px; text-decoration:none; color:#111827; border:1px solid var(--border);
    margin-bottom:8px; transition: background .15s ease, border-color .15s ease;
  }
  .menu a.active{ background:#eef4ff; border-color:#cfe3ff; color:#0b3d91; font-weight:800; }
  .menu a:hover{ background:#f8fafc; }

  .content{ padding:12px; }

  .kpis{ display:grid; grid-template-columns: repeat(5, 1fr); gap:12px; }
  @media (max-width: 1100px){ .kpis{ grid-template-columns: repeat(3,1fr); } }
  @media (max-width: 700px){ .kpis{ grid-template-columns: repeat(2,1fr); } }
  .kpi{
    background:#fff; border:1px solid var(--border); border-radius:12px; padding:12px;
  }
  .kpi .label{ color:#6b7280; font-size:12px; margin-bottom:6px;}
  .kpi .value{ font-size:20px; font-weight:900; }
  .kpi .sub{ font-size:12px; color:#6b7280; }

  .grid-2{ display:grid; grid-template-columns: 1.2fr .8fr; gap:12px; margin-top:12px; }
  @media (max-width: 900px){ .grid-2{ grid-template-columns:1fr; } }

  .card{ background:#fff; border:1px solid var(--border); border-radius:12px; padding:12px; }
  .card h4{ margin:0 0 8px; font-size:16px; }

  .bars{ display:flex; align-items:flex-end; gap:8px; height:140px; padding:10px; background:#fafbff; border:1px dashed #dfe6ff; border-radius:10px; }
  .bar{
    width: 24px; background:linear-gradient(180deg, #7cb3ff, #3f83f8);
    border-radius:6px 6px 0 0; position:relative;
  }
  .bar label{
    position:absolute; bottom:-18px; left:50%; transform:translateX(-50%);
    font-size:11px; color:#6b7280; white-space:nowrap;
  }
  .bar .val{
    position:absolute; top:-20px; left:50%; transform:translateX(-50%);
    font-size:11px; background:#0b3d91; color:#fff; padding:2px 6px; border-radius:10px;
    display:none;
  }
  .bar:hover .val{ display:block; }

  table{ width:100%; border-collapse: collapse; }
  th, td{ border:1px solid #eaeaea; padding:8px; text-align:left; }
  th{ background:#f7f8fb; }
  .right{ text-align:right; }
  .muted{ color:#6b7280; font-size:12px; }
  .status-badge{
    display:inline-flex; align-items:center; gap:6px; font-weight:800; font-size:12px;
    padding:4px 8px; border-radius:999px; border:1px solid #eaeaea;
  }
  .status-lunas{ background:#e7fff0; color:#047857; border-color:#bbf7d0; }
  .status-hutang{ background:#fff4f3; color:#b91c1c; border-color:#fecaca; }

  /* Periodik */
  .filters{ display:flex; gap:10px; flex-wrap:wrap; margin-bottom:10px; }
  .control{
    min-width: 180px; padding:8px 10px; border:1px solid var(--border);
    border-radius:10px; outline:none; background:#fff;
    transition: box-shadow .15s ease, border-color .15s ease;
  }
  .control:focus{ border-color:#cfe3ff; box-shadow:0 0 0 4px var(--ring); }
  .btn{ border:none; border-radius:10px; padding:9px 12px; cursor:pointer; font-weight:800; color:#fff; background:var(--brand); }
  .btn:hover{ background:var(--brand-hover); }
  .btn-muted{ background:#6b7280; }
  .cards{ display:grid; grid-template-columns: repeat(5,1fr); gap:10px; }
  @media (max-width: 1100px){ .cards{ grid-template-columns: repeat(3,1fr); } }
  @media (max-width: 700px){ .cards{ grid-template-columns: repeat(2,1fr); } }
</style>
{% endblock %}

{% block content %}

<div class="wrap">

  <!-- MENU KIRI -->
  <aside class="panel menu" aria-label="Jenis Laporan">
    <h3>Jenis Laporan</h3>
    <a href="{{ url_for('laporan_home', view='overview') }}" class="{{ 'active' if current_view=='overview' else '' }}">üè† Overview (Dashboard)</a>
    <a href="{{ url_for('laporan_home', view='periodik') }}" class="{{ 'active' if current_view=='periodik' else '' }}">üìÜ Penjualan Periodik</a>
  </aside>

  <!-- KONTEN KANAN -->
  <section class="panel content">

    {% if current_view == 'overview' %}
      <h2 style="margin:0 0 8px;">Dashboard Ringkas</h2>
      <div class="muted">Snapshot per {{ today.strftime('%d/%m/%Y') }}</div>

      <!-- KPIs -->
      <div class="kpis" style="margin-top:10px;">
        <div class="kpi">
          <div class="label">Omzet Hari Ini</div>
          <div class="value">{{ rupiah(omzet_today or 0) }}</div>
          <div class="sub">Transaksi: {{ trx_today or 0 }}</div>
        </div>
        <div class="kpi">
          <div class="label">Omzet 7 Hari</div>
          <div class="value">{{ rupiah(omzet_last7 or 0) }}</div>
          <div class="sub">{{ last7_start.strftime('%d/%m') }} ‚Äî {{ today.strftime('%d/%m') }}</div>
        </div>
        <div class="kpi">
          <div class="label">Omzet Bulan Ini</div>
          <div class="value">{{ rupiah(omzet_month or 0) }}</div>
          <div class="sub">Mulai {{ month_start.strftime('%d/%m') }}</div>
        </div>
        <div class="kpi">
          <div class="label">Hutang Outstanding</div>
          <div class="value" style="color:#b91c1c;">{{ rupiah(total_hutang_outstanding or 0) }}</div>
          <div class="sub">{{ count_hutang_outstanding or 0 }} transaksi</div>
        </div>
        <div class="kpi">
          <div class="label">Top Produk (30 Hari)</div>
          <div class="value">
            {% if top_produk_30 and top_produk_30|length>0 %}
              {{ top_produk_30[0].nama }}
            {% else %}
              -
            {% endif %}
          </div>
          <div class="sub">Berdasarkan jumlah terjual</div>
        </div>
      </div>

      <!-- grafik + top produk -->
      <div class="grid-2">
        <div class="card">
          <h4>Grafik Omzet 7 Hari Terakhir</h4>
          {% set vmax = (series_values | max) if series_values else 1 %}
          <div class="bars">
            {% for i in range(series_values|length) %}
              {% set val = series_values[i] %}
              {% set label = series_labels[i] %}
              {% set h = ( (val*1.0 / (vmax if vmax>0 else 1)) * 120 ) | round(0, 'floor') %}
              <div class="bar" style="height: {{ h + 10 }}px;">
                <div class="val">{{ rupiah(val) }}</div>
                <label>{{ label }}</label>
              </div>
            {% endfor %}
          </div>
          <div class="muted" style="margin-top:6px;">Hover bar untuk lihat nilai.</div>
        </div>

        <div class="card">
          <h4>Top Produk 30 Hari (Qty)</h4>
          <table>
            <thead><tr><th>Produk</th><th class="right">Qty</th></tr></thead>
            <tbody>
              {% for r in top_produk_30 %}
              <tr>
                <td>{{ r.nama }}</td>
                <td class="right">{{ r.qty }}</td>
              </tr>
              {% else %}
              <tr><td colspan="2" class="muted">Belum ada data.</td></tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>

      <!-- transaksi hari ini + hutang terbaru -->
      <div class="grid-2" style="margin-top:12px;">
        <div class="card">
          <h4>Transaksi Hari Ini</h4>
          <table>
            <thead>
              <tr>
                <th>#</th><th>Tanggal</th><th>Pelanggan</th><th class="right">Total</th><th>Status</th><th>Aksi</th>
              </tr>
            </thead>
            <tbody>
              {% for t in trx_today_rows %}
              <tr>
                <td>{{ t.id }}</td>
                <td>{{ t.tanggal|format_tanggal }}</td>
                <td>{{ t.customer.nama if t.customer else '-' }}</td>
                <td class="right">{{ rupiah(t.total or 0) }}</td>
                <td>
                  {% set sisa = t.sisa or (t.total - (t.bayar or 0)) %}
                  {% if sisa > 0 %}
                    <span class="status-badge status-hutang">HUTANG</span>
                  {% else %}
                    <span class="status-badge status-lunas">LUNAS</span>
                  {% endif %}
                </td>
                <td><a href="{{ url_for('transaksi_detail', id=t.id) }}">Detail</a></td>
              </tr>
              {% else %}
              <tr><td colspan="6" class="muted">Belum ada transaksi hari ini.</td></tr>
              {% endfor %}
            </tbody>
          </table>
        </div>

        <div class="card">
          <h4>Hutang Outstanding Terbaru</h4>
          <table>
            <thead>
              <tr><th>#</th><th>Pelanggan</th><th class="right">Sisa</th><th>Tempo</th><th>Aksi</th></tr>
            </thead>
            <tbody>
              {% for t in hutang_terbaru %}
              <tr>
                <td>{{ t.id }}</td>
                <td>{{ t.customer.nama if t.customer else '-' }}</td>
                <td class="right">{{ rupiah(t.sisa or 0) }}</td>
                <td>{{ t.jatuh_tempo or '-' }}</td>
                <td><a href="{{ url_for('transaksi_detail', id=t.id) }}">Detail</a></td>
              </tr>
              {% else %}
              <tr><td colspan="5" class="muted">Tidak ada hutang outstanding.</td></tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>

    {% elif current_view == 'periodik' %}
      <h2 style="margin:0 0 10px;">Laporan Penjualan Periodik</h2>

      <!-- Filter -->
      <form method="get" action="{{ url_for('laporan_home') }}" class="filters">
        <input type="hidden" name="view" value="periodik">
        <input type="date" name="start" class="control" value="{{ start }}">
        <input type="date" name="end" class="control" value="{{ end }}">
        <select name="status" class="control">
          <option value="all"   {{ 'selected' if status=='all' }}>Semua</option>
          <option value="lunas" {{ 'selected' if status=='lunas' }}>LUNAS</option>
          <option value="hutang"{{ 'selected' if status=='hutang' }}>HUTANG</option>
        </select>
        <button class="btn" type="submit">Terapkan</button>
        <a class="btn btn-muted" href="{{ url_for('laporan_home', view='periodik') }}" style="text-decoration:none;">Reset</a>
      </form>

      <!-- Ringkasan -->
      <div class="cards" style="margin-bottom:10px;">
        <div class="card">
          <div class="label">Jumlah Transaksi</div>
          <div class="value">{{ total_trx or 0 }}</div>
        </div>
        <div class="card">
          <div class="label">Total Penjualan</div>
          <div class="value">{{ rupiah(total_penjualan or 0) }}</div>
        </div>
        <div class="card">
          <div class="label">Total Dibayar</div>
          <div class="value">{{ rupiah(total_dibayar or 0) }}</div>
        </div>
        <div class="card">
          <div class="label">Total Sisa (Hutang)</div>
          <div class="value" style="color:#b91c1c;">{{ rupiah(total_sisa or 0) }}</div>
        </div>
        <div class="card">
          <div class="label">Avg Ticket Size</div>
          <div class="value">{{ rupiah(avg_ticket|int) }}</div>
        </div>
      </div>

      <!-- Drill-down daftar transaksi -->
      <div class="card">
        <h4>Detail Transaksi ({{ start }} s/d {{ end }})</h4>
        <table>
          <thead>
            <tr>
              <th>#</th><th>Tanggal</th><th>Pelanggan</th>
              <th class="right">Total</th><th class="right">Bayar</th><th class="right">Sisa</th>
              <th>Status</th><th>Aksi</th>
            </tr>
          </thead>
          <tbody>
            {% for r in drill_rows %}
            <tr>
              <td>{{ r.id }}</td>
              <td>{{ r.tanggal|format_tanggal }}</td>
              <td>{{ r.customer }}</td>
              <td class="right">{{ rupiah(r.total) }}</td>
              <td class="right">{{ rupiah(r.bayar) }}</td>
              <td class="right">{{ rupiah(r.sisa) }}</td>
              <td>
                {% if r.status == 'HUTANG' %}
                  <span class="status-badge status-hutang">HUTANG</span>
                {% else %}
                  <span class="status-badge status-lunas">LUNAS</span>
                {% endif %}
              </td>
              <td><a href="{{ url_for('transaksi_detail', id=r.id) }}">Detail</a></td>
            </tr>
            {% else %}
            <tr><td colspan="8" class="muted">Tidak ada transaski pada periode/filter ini.</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

    {% else %}
      <p class="muted">Silakan pilih jenis laporan di panel kiri.</p>
    {% endif %}

  </section>
</div>

{% endblock %}