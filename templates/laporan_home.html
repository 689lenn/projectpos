{% extends "base.html" %}
{% block title %}Laporan & Analitik{% endblock %}

{% block head %}
<!-- Chart.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  .cards { display:grid; grid-template-columns: repeat(3, 1fr); gap:12px; }
  @media (max-width: 960px){ .cards{ grid-template-columns:1fr; } }

  .card { background:#fff; border:1px solid #e5e7eb; border-radius:12px; padding:14px; }
  .card h3{ margin:0 0 6px 0; font-size:14px; color:#6b7280; font-weight:700; }
  .num { font-size:20px; font-weight:800; }
  .muted{ color:#6b7280; font-size:12px; }

  .section-title{ font-size:18px; margin:8px 0; font-weight:800; }
  table{ width:100%; border-collapse:collapse; }
  th, td{ border-bottom:1px solid #eee; padding:8px; text-align:left; }
  th{ background:#f9fafb; color:#6b7280; font-size:13px; }
  .right{ text-align:right; }
  .wrap{ max-width:1160px; margin:0 auto; }
  .tabs{ display:flex; gap:10px; margin-bottom:12px; }
  .tab{ display:inline-block; padding:8px 12px; border-radius:8px; background:#eef2ff; color:#1f2937; text-decoration:none; border:1px solid #c7d2fe; font-weight:700; }
  .tab.active{ background:#1d4ed8; color:#fff; border-color:#1d4ed8; }
  .row{ display:flex; gap:12px; flex-wrap:wrap; align-items:center; }

  .charts { display:grid; grid-template-columns: 2fr 1fr; gap:12px; margin-top:12px; }
  @media (max-width: 1080px){ .charts{ grid-template-columns:1fr; } }

  .chart-card { background:#fff; border:1px solid #e5e7eb; border-radius:12px; padding:10px 12px; }
  .chart-title{ font-size:14px; color:#6b7280; font-weight:700; margin-bottom:6px; }
</style>
{% endblock %}

{% block content %}
<div class="wrap">
  <h1>Laporan & Analitik</h1>

  <div class="tabs">
    <a class="tab {% if current_view=='overview' %}active{% endif %}" href="{{ url_for('laporan_home', view='overview') }}">Overview</a>
    <a class="tab {% if current_view=='periodik' %}active{% endif %}" href="{{ url_for('laporan_home', view='periodik') }}">Laporan Periodik</a>
  </div>

  {% if current_view == 'overview' %}
    <!-- ====== OVERVIEW ====== -->
    <div class="cards">
      <div class="card">
        <h3>Omzet Hari Ini</h3>
        <div class="num">{{ rupiah(omzet_today or 0) }}</div>
        <div class="muted">Transaksi: <strong>{{ trx_today or 0 }}</strong></div>
      </div>
      <div class="card">
        <h3>Laba Hari Ini (approx)</h3>
        <div class="num">{{ rupiah(laba_today or 0) }}</div>
        <div class="muted">Perkiraan (Total – Σ HPP×qty)</div>
      </div>
      <div class="card">
        <h3>Hutang Outstanding</h3>
        <div class="num">{{ rupiah(total_hutang_outstanding or 0) }}</div>
        <div class="muted">Invoice: {{ count_hutang_outstanding or 0 }}</div>
      </div>
    </div>

    <div class="cards" style="margin-top:12px;">
      <div class="card">
        <h3>Omzet 7 Hari</h3>
        <div class="num">{{ rupiah(omzet_last7 or 0) }}</div>
        <div class="muted">Periode: {{ last7_start.strftime("%d/%m") }} - {{ today.strftime("%d/%m") }}</div>
      </div>
      <div class="card">
        <h3>Laba 7 Hari (approx)</h3>
        <div class="num">{{ rupiah(laba_last7 or 0) }}</div>
        <div class="muted">Periode sama</div>
      </div>
      <div class="card">
        <h3>Omzet Bulan Ini</h3>
        <div class="num">{{ rupiah(omzet_month or 0) }}</div>
        <div class="muted">Mulai {{ month_start.strftime("%d/%m") }}</div>
      </div>
    </div>

    <div class="cards" style="margin-top:12px;">
      <div class="card">
        <h3>Laba Bulan Ini (approx)</h3>
        <div class="num">{{ rupiah(laba_month or 0) }}</div>
        <div class="muted">Perkiraan</div>
      </div>
      <div class="card">
        <h3>Top Produk 30 Hari (Qty)</h3>
        {% if top_produk_30 %}
          <table>
            <thead><tr><th>Produk</th><th class="right">Qty</th></tr></thead>
            <tbody>
              {% for r in top_produk_30 %}
                <tr><td>{{ r.nama }}</td><td class="right">{{ r.qty }}</td></tr>
              {% endfor %}
            </tbody>
          </table>
        {% else %}
          <div class="muted">Belum ada data</div>
        {% endif %}
      </div>
      <div class="card">
        <h3>Hutang Terbaru</h3>
        {% if hutang_terbaru %}
          <table>
            <thead><tr><th>#</th><th>Customer</th><th class="right">Sisa</th></tr></thead>
            <tbody>
              {% for t in hutang_terbaru %}
                {% set _bayar = t.bayar or 0 %}
                {% set _total = t.total or 0 %}
                {% set _sisa = (t.sisa if t.sisa is not none else (_total - _bayar)) %}
                {% if _sisa < 0 %}{% set _sisa = 0 %}{% endif %}
                <tr>
                  <td>#{{ t.id }}</td>
                  <td>{{ t.customer.nama if t.customer else '-' }}</td>
                  <td class="right">{{ rupiah(_sisa) }}</td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        {% else %}
          <div class="muted">Tidak ada</div>
        {% endif %}
      </div>
    </div>

    <!-- ====== GRAFIK OVERVIEW ====== -->
    <div class="charts">
      <div class="chart-card">
        <div class="chart-title">Grafik 7 Hari: Omzet & Laba</div>
        <canvas id="chart7"></canvas>
      </div>

      <div class="chart-card">
        <div class="chart-title">Distribusi Hari Ini: Dibayar vs Sisa</div>
        <canvas id="chartPieToday"></canvas>
      </div>
    </div>

    <div class="chart-card" style="margin-top:12px;">
      <div class="chart-title">Top Produk 30 Hari (Qty)</div>
      <canvas id="chartTop30"></canvas>
    </div>

    <div class="card" style="margin-top:12px;">
      <div class="section-title">Transaksi Hari Ini</div>
      {% if trx_today_rows %}
        <table>
          <thead>
            <tr><th>#</th><th>Tanggal</th><th>Customer</th><th class="right">Total</th><th class="right">Status</th></tr>
          </thead>
          <tbody>
            {% for t in trx_today_rows %}
              {% set _bayar = t.bayar or 0 %}
              {% set _total = t.total or 0 %}
              {% set _sisa = (t.sisa if t.sisa is not none else (_total - _bayar)) %}
              {% if _sisa < 0 %}{% set _sisa = 0 %}{% endif %}
              <tr>
                <td><a href="{{ url_for('transaksi_detail', id=t.id) }}">#{{ t.id }}</a></td>
                <td>{{ t.tanggal }}</td>
                <td>{{ t.customer.nama if t.customer else '-' }}</td>
                <td class="right">{{ rupiah(t.total or 0) }}</td>
                <td class="right">{{ 'HUTANG' if _sisa > 0 else 'LUNAS' }}</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      {% else %}
        <div class="muted">Belum ada transaksi.</div>
      {% endif %}
    </div>
  {% endif %}

  {% if current_view == 'periodik' %}
    <!-- ====== PERIODIK ====== -->
    <div class="card">
      <form method="get" class="row">
        <input type="hidden" name="view" value="periodik">
        <div>
          <label>Mulai</label>
          <input class="control" type="date" name="start" value="{{ start }}">
        </div>
        <div>
          <label>Sampai</label>
          <input class="control" type="date" name="end" value="{{ end }}">
        </div>
        <div>
          <label>Status</label>
          <select class="control" name="status">
            <option value="all"   {% if status=='all' %}selected{% endif %}>Semua</option>
            <option value="lunas" {% if status=='lunas' %}selected{% endif %}>Lunas</option>
            <option value="hutang"{% if status=='hutang' %}selected{% endif %}>Hutang</option>
          </select>
        </div>
        <div style="align-self:end;"><button class="btn btn-primary" type="submit">Terapkan</button></div>
      </form>
    </div>

    <div class="charts">
      <div class="chart-card">
        <div class="chart-title">Grafik Periode: Omzet & Laba</div>
        <canvas id="chartPeriod"></canvas>
      </div>
      <div class="chart-card">
        <div class="chart-title">Distribusi Periode: Dibayar vs Sisa</div>
        <canvas id="chartPiePeriod"></canvas>
      </div>
    </div>

    <div class="chart-card" style="margin-top:12px;">
      <div class="chart-title">Top Produk Periode (Qty)</div>
      <canvas id="chartTopPeriod"></canvas>
    </div>

    <div class="card" style="margin-top:12px;">
      <div class="section-title">Rincian Transaksi</div>
      <table>
        <thead>
          <tr>
            <th>#</th>
            <th>Tanggal</th>
            <th>Customer</th>
            <th class="right">Total</th>
            <th class="right">HPP (approx)</th>
            <th class="right">Laba (approx)</th>
            <th class="right">Dibayar</th>
            <th class="right">Sisa</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody>
          {% for r in drill_rows %}
            <tr>
              <td><a href="{{ url_for('transaksi_detail', id=r.id) }}">#{{ r.id }}</a></td>
              <td>{{ r.tanggal }}</td>
              <td>{{ r.customer }}</td>
              <td class="right">{{ rupiah(r.total) }}</td>
              <td class="right">{{ rupiah(r.hpp_cost) }}</td>
              <td class="right">{{ rupiah(r.laba) }}</td>
              <td class="right">{{ rupiah(r.bayar) }}</td>
              <td class="right">{{ rupiah(r.sisa) }}</td>
              <td>{{ r.status }}</td>
            </tr>
          {% else %}
            <tr><td colspan="9">Tidak ada transaksi pada periode ini.</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  {% endif %}
</div>

{% if current_view == 'overview' %}
<script>
(function(){
  function initCharts(){
    try {
      const labels7   = {{ series_labels|tojson|safe }};
      const omzet7    = {{ series_omzet|tojson|safe }};
      const laba7     = {{ series_laba|tojson|safe }};
      const paidToday = {{ (paid_today or 0)|int }};
      const sisaToday = {{ (sisa_today or 0)|int }};
      const topNames  = {{ top30_names|tojson|safe }};
      const topQtys   = {{ top30_qtys|tojson|safe }};

      // Line: 7 Hari
      new Chart(document.getElementById('chart7'), {
        type: 'line',
        data: {
          labels: labels7,
          datasets: [
            {label:'Omzet', data: omzet7, borderColor:'#1d4ed8', backgroundColor:'rgba(29,78,216,.15)', tension:.3, fill:true},
            {label:'Laba',  data: laba7,  borderColor:'#10b981', backgroundColor:'rgba(16,185,129,.15)', tension:.3, fill:true},
          ]
        },
        options: { responsive:true, plugins:{ legend:{ position:'top' } }, scales:{ y:{ beginAtZero:true } } }
      });

      // Pie: Hari Ini
      new Chart(document.getElementById('chartPieToday'), {
        type:'doughnut',
        data:{ labels:['Dibayar','Sisa'], datasets:[{ data:[paidToday, sisaToday], backgroundColor:['#22c55e','#ef4444'] }] },
        options:{ responsive:true, plugins:{ legend:{ position:'bottom' } } }
      });

      // Bar: Top 30 hari
      new Chart(document.getElementById('chartTop30'), {
        type:'bar',
        data:{ labels: topNames, datasets:[{ label:'Qty', data: topQtys, backgroundColor:'#f59e0b' }] },
        options:{ responsive:true, plugins:{ legend:{ display:false } }, scales:{ y:{ beginAtZero:true } } }
      });
    } catch(e) {
      console.error('Chart init error (overview):', e);
    }
  }

  function ensureChartJSAndInit(){
    if (window.Chart) { initCharts(); return; }
    var s = document.createElement('script');
    s.src = 'https://cdn.jsdelivr.net/npm/chart.js';
    s.onload = initCharts;
    document.body.appendChild(s);
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', ensureChartJSAndInit);
  } else {
    ensureChartJSAndInit();
  }
})();
</script>
{% endif %}

{% if current_view == 'periodik' %}
<script>
(function(){
  function initCharts(){
    try {
      const pLabels = {{ period_labels|tojson|safe }};
      const pOmzet  = {{ period_omzet|tojson|safe }};
      const pLaba   = {{ period_laba|tojson|safe }};
      const pPaid   = {{ (paid_sum or 0)|int }};
      const pSisa   = {{ (sisa_sum or 0)|int }};
      const pTopNm  = {{ top_names_p|tojson|safe }};
      const pTopQty = {{ top_qtys_p|tojson|safe }};

      // Line: Periode
      new Chart(document.getElementById('chartPeriod'), {
        type: 'line',
        data: {
          labels: pLabels,
          datasets: [
            {label:'Omzet', data: pOmzet, borderColor:'#1d4ed8', backgroundColor:'rgba(29,78,216,.15)', tension:.3, fill:true},
            {label:'Laba',  data: pLaba,  borderColor:'#10b981', backgroundColor:'rgba(16,185,129,.15)', tension:.3, fill:true},
          ]
        },
        options: { responsive:true, plugins:{ legend:{ position:'top' } }, scales:{ y:{ beginAtZero:true } } }
      });

      // Pie: Periode
      new Chart(document.getElementById('chartPiePeriod'), {
        type:'doughnut',
        data:{ labels:['Dibayar','Sisa'], datasets:[{ data:[pPaid, pSisa], backgroundColor:['#22c55e','#ef4444'] }] },
        options:{ responsive:true, plugins:{ legend:{ position:'bottom' } } }
      });

      // Bar: Top produk (periode)
      new Chart(document.getElementById('chartTopPeriod'), {
        type:'bar',
        data:{ labels:pTopNm, datasets:[{ label:'Qty', data:pTopQty, backgroundColor:'#f59e0b' }] },
        options:{ responsive:true, plugins:{ legend:{ display:false } }, scales:{ y:{ beginAtZero:true } } }
      });
    } catch(e) {
      console.error('Chart init error (periodik):', e);
    }
  }

  function ensureChartJSAndInit(){
    if (window.Chart) { initCharts(); return; }
    var s = document.createElement('script');
    s.src = 'https://cdn.jsdelivr.net/npm/chart.js';
    s.onload = initCharts;
    document.body.appendChild(s);
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', ensureChartJSAndInit);
  } else {
    ensureChartJSAndInit();
  }
})();
</script>
{% endif %}

{% if current_view == 'periodik' %}
<script>
  // Data untuk periodik
  const pLabels = {{ period_labels|tojson }};
  const pOmzet  = {{ period_omzet|tojson }};
  const pLaba   = {{ period_laba|tojson }};
  const pPaid   = {{ (paid_sum or 0)|int }};
  const pSisa   = {{ (sisa_sum or 0)|int }};
  const pTopNm  = {{ top_names_p|tojson }};
  const pTopQty = {{ top_qtys_p|tojson }};

  // Line: Omzet & Laba per hari
  new Chart(document.getElementById('chartPeriod'), {
    type: 'line',
    data: {
      labels: pLabels,
      datasets: [
        {label:'Omzet', data: pOmzet, borderColor:'#1d4ed8', backgroundColor:'rgba(29,78,216,.15)', tension:.3, fill:true},
        {label:'Laba',  data: pLaba,  borderColor:'#10b981', backgroundColor:'rgba(16,185,129,.15)', tension:.3, fill:true},
      ]
    },
    options: {
      responsive:true,
      plugins:{ legend:{ position:'top' } },
      scales:{ y:{ beginAtZero:true } }
    }
  });

  // Doughnut: Dibayar vs Sisa (periode)
  new Chart(document.getElementById('chartPiePeriod'), {
    type:'doughnut',
    data:{
      labels:['Dibayar','Sisa'],
      datasets:[{ data:[pPaid, pSisa], backgroundColor:['#22c55e','#ef4444'] }]
    },
    options:{ responsive:true, plugins:{ legend:{ position:'bottom' } } }
  });

  // Bar: Top produk periode
  new Chart(document.getElementById('chartTopPeriod'), {
    type:'bar',
    data:{ labels:pTopNm, datasets:[{ label:'Qty', data:pTopQty, backgroundColor:'#f59e0b' }] },
    options:{ responsive:true, plugins:{ legend:{ display:false } }, scales:{ y:{ beginAtZero:true } } }
  });
</script>
{% endif %}
{% endblock %}