{% extends "base.html" %}
{% block title %}Detail Transaksi #{{ transaksi.id }}{% endblock %}

{% block head %}
<style>
  :root{
    --card:#fff; --border:#e6e8f0; --muted:#6b7280; --text:#111827;
    --brand:#007bff; --brand-hover:#0064cf; --ring: rgba(0,123,255,.25);
    --radius:12px; --shadow:0 10px 25px rgba(0,0,0,.06);
    --ok:#16a34a; --warn:#f59e0b; --danger:#ef4444;
  }
  .wrap { max-width: 840px; margin: 0 auto; }
  .card {
    background:var(--card); border:1px solid var(--border);
    border-radius:var(--radius); padding:16px; box-shadow: var(--shadow);
  }
  h1.title { margin:4px 0 10px; }
  .actions { display:flex; gap:10px; justify-content:flex-end; margin-bottom: 12px; }
  .btn { border:none; border-radius:10px; padding:10px 14px; cursor:pointer; font-weight:700; color:#fff; text-decoration:none; }
  .btn-muted { background:#6c757d; }
  .btn-muted:hover { filter: brightness(.95); }
  .btn-primary{ background:var(--brand); }
  .btn-primary:hover{ background:var(--brand-hover); }

  .meta{
    display:grid; grid-template-columns: 1fr 1fr; gap: 10px;
    background:#fafbff; border:1px solid #e9ecf4; border-radius:12px; padding:10px 12px; margin-bottom:14px;
  }
  .mrow{ display:flex; justify-content:space-between; gap:10px; }
  .mkey{ color:var(--muted); }
  .badge{ display:inline-flex; align-items:center; padding:4px 8px; border-radius:999px; font-size:12px; font-weight:800; }
  .badge.lunas{ background:#e6f9ed; color:#146c2e; border:1px solid #c5efd3; }
  .badge.hutang{ background:#fff6e5; color:#995700; border:1px solid #ffe2ad; }

  table { width:100%; border-collapse:collapse; margin-top: 6px; }
  th, td { border:1px solid #eaecef; padding:8px; }
  th { background:#f6f7fb; text-align:left; }
  .right { text-align:right; }

  .total-box{
    margin-top:12px; background:#f9fafc; border:1px solid #e9ecf4; border-radius:12px; padding:12px;
  }
  .row { display:flex; align-items:center; justify-content:space-between; margin:6px 0; }
  .row strong { font-size: 16px; }

  .note {
    margin-top:10px; padding:10px 12px; border-left:4px solid var(--warn);
    background:#fff8e7; color:#7a5200; border-radius:8px;
  }

  @media print {
    body { background:#fff; }
    .actions, .btn { display:none !important; }
    .card { box-shadow:none; border:none; }
  }
</style>
{% endblock %}

{% block content %}
<div class="wrap">
  <div class="actions no-print">
    <a href="{{ prev_url }}" class="btn btn-muted">‚Üê Kembali</a>
    <button class="btn btn-primary" id="btnPrint">üñ®Ô∏è Cetak</button>
    <button class="btn btn-muted" id="btnShare">üîó Share</button>
  </div>

  <div class="card" id="receipt">
    <h1 class="title">Detail Transaksi</h1>

    <!-- META -->
    <div class="meta">
      <div class="mrow">
        <span class="mkey">No. Transaksi</span>
        <span>#{{ transaksi.id }}</span>
      </div>
      <div class="mrow">
        <span class="mkey">Tanggal</span>
        <span>{{ transaksi.tanggal|format_tanggal if transaksi.tanggal else '-' }}</span>
      </div>
      <div class="mrow">
        <span class="mkey">Status</span>
        <span>
          {% if transaksi.status == 'HUTANG' %}
            <span class="badge hutang">HUTANG</span>
          {% else %}
            <span class="badge lunas">LUNAS</span>
          {% endif %}
        </span>
      </div>
      <div class="mrow">
        <span class="mkey">Pelanggan</span>
        <span>
          {% if transaksi.customer %}
            {{ transaksi.customer.nama }} ‚Äî {{ transaksi.customer.email }}
          {% else %}
            (Tanpa pelanggan)
          {% endif %}
        </span>
      </div>
    </div>

    <!-- ITEMS -->
    <table>
      <thead>
        <tr>
          <th>Produk</th>
          <th class="right">Qty</th>
        </tr>
      </thead>
      <tbody>
        {% for it in transaksi.item_transaksi %}
          {% set p = it.produk %}
          <tr>
            <td>
              <div><strong>{{ p.nama if p else 'Produk #' ~ it.produk_id }}</strong></div>
            </td>
            <td class="right">{{ it.jumlah }}</td>
          </tr>
        {% endfor %}
      </tbody>
    </table>

    <!-- TOTAL & PEMBAYARAN -->
    <div class="total-box">
      <div class="row"><span>Total</span><strong>Rp {{ "{:,}".format(transaksi.total|int) }}</strong></div>

      {% if transaksi.status == 'HUTANG' %}
        <div class="row"><span>Bayar Saat Ini</span><strong>Rp {{ "{:,}".format((transaksi.bayar or 0)|int) }}</strong></div>
        <div class="row"><span>Sisa Hutang</span><strong style="color:#b45309;">Rp {{ "{:,}".format((transaksi.sisa or 0)|int) }}</strong></div>
        {% if transaksi.jatuh_tempo %}
          <div class="row"><span>Jatuh Tempo</span><strong>{{ transaksi.jatuh_tempo|format_tanggal }}</strong></div>
        {% endif %}
      {% else %}
        <div class="row"><span>Bayar</span><strong>Rp {{ "{:,}".format((transaksi.bayar or 0)|int) }}</strong></div>
        <div class="row"><span>Kembalian</span><strong>Rp {{ "{:,}".format((transaksi.kembalian or 0)|int) }}</strong></div>
      {% endif %}
    </div>

    {% if transaksi.status == 'HUTANG' %}
      <div class="note">
        Transaksi ini tersimpan sebagai <strong>HUTANG</strong>.  
        Sisa yang belum dibayar: <strong>Rp {{ "{:,}".format((transaksi.sisa or 0)|int) }}</strong>.
        {% if transaksi.jatuh_tempo %}Jatuh tempo pada <strong>{{ transaksi.jatuh_tempo|format_tanggal }}</strong>.{% endif %}
        <br>Pelunasan dapat dilakukan di menu <em>Hutang Piutang</em> (akan kita buat di modul terpisah).
      </div>
    {% endif %}
  </div>
</div>

<script>
  // Cetak
  document.getElementById('btnPrint')?.addEventListener('click', ()=>{ window.print(); });

  // Share (Web Share API)
  document.getElementById('btnShare')?.addEventListener('click', async ()=>{
    const url = window.location.href;
    const title = 'Detail Transaksi #{{ transaksi.id }}';
    const text = 'Total: Rp {{ "{:,}".format(transaksi.total|int) }} ‚Äî Status: {{ transaksi.status }}';

    if (navigator.share) {
      try {
        await navigator.share({ title, text, url });
      } catch(e) {}
    } else {
      // Fallback: copy ke clipboard
      try{
        await navigator.clipboard.writeText(`${title}\n${text}\n${url}`);
        alert('Link transaksi disalin ke clipboard.');
      }catch(e){
        alert(url);
      }
    }
  });
</script>
{% endblock %}