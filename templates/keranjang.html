{% extends "base.html" %}
{% block title %}Keranjang{% endblock %}

{% block head %}
<style>
  .cart { background:#fff; padding:1rem; border-radius:8px; }
  table { width:100%; border-collapse:collapse; }
  th, td { border:1px solid #ddd; padding:8px; text-align:left; }
  th { background:#f3f3f3; }
  .right { text-align:right; }
  .actions { display:flex; gap:8px; flex-wrap:wrap; }
  .topbar { margin-bottom:10px; display:flex; gap:10px; }

  input[type="number"] { width:90px; }

  .footer-actions{
    margin-top:12px; display:flex; gap:8px; justify-content:flex-end; flex-wrap:wrap;
  }

  /* Link harga (klik untuk ubah) */
  .price-link{
    display:inline-block; padding:4px 8px; border-radius:6px; cursor:pointer;
    background:#f3f4f6; border:1px solid #e5e7eb; color:#111827; text-decoration:none;
  }
  .price-link:hover{ background:#eef2ff; border-color:#c7d2fe; }

  /* Modal ringkas */
  .modal-backdrop{position:fixed; inset:0; background:rgba(16,24,40,.4); display:none; align-items:center; justify-content:center; z-index:2000;}
  .modal-backdrop.show{display:flex;}
  .modal{
    width:min(520px, 92vw); background:#fff; border-radius:12px; box-shadow:0 30px 60px rgba(0,0,0,.2);
    overflow:hidden;
  }
  .modal-head{display:flex; align-items:center; justify-content:space-between; padding:12px 14px; border-bottom:1px solid #eef1f5;}
  .modal-body{padding:14px;}
  .modal-foot{padding:12px 14px; border-top:1px solid #eef1f5; display:flex; justify-content:flex-end; gap:8px;}
</style>
{% endblock %}

{% block content %}
<h1>Keranjang</h1>

<div class="topbar">
  <a class="btn btn-primary" href="{{ url_for('index') }}">‚Üê Pilih Produk Lagi</a>
</div>

<div class="cart">
  {% if keranjang %}

  <!-- FORM UPDATE QTY (HANYA JUMLAH, AUTO-SAVE) -->
  <form id="updateForm" action="{{ url_for('keranjang_update') }}" method="post">
    <table>
      <thead>
        <tr>
          <th>Produk</th>
          <th>Harga</th>
          <th>Jumlah (edit)</th>
          <th class="right">Subtotal</th>
          <th>Aksi</th>
        </tr>
      </thead>
      <tbody>
        {% for key, item in keranjang.items() %}
          {% set subtotal = item.harga * item.jumlah %}
          <tr>
            <td>
              <div><strong>{{ item.nama }}</strong></div>
              {% if item.stok is defined %}
                <div style="font-size:12px;color:#666;">Stok: {{ item.stok }}</div>
              {% endif %}
              <input type="hidden" name="key[]" value="{{ key }}">
            </td>
            <td>
              <!-- Harga ditampilkan sebagai link; klik ‚Üí modal ubah harga -->
              <a href="#" class="price-link"
                 onclick="openPriceModal('{{ key }}', {{ item.harga }}, '{{ item.nama|e }}'); return false;">
                 Rp {{ '{:,}'.format(item.harga) }}
              </a>
            </td>
            <td>
              <input type="number"
                     name="qty[]"
                     min="0"
                     value="{{ item.jumlah }}"
                     oninput="autoSaveQty()">
              <!-- Harga snapshot yang dipakai hitung -->
              <input type="hidden" name="price[]" value="{{ item.harga }}">
              <!-- HPP per item (diisi dari backend) -->
              <input type="hidden" class="hpp-val" value="{{ produk_hpp.get(key, 0) }}">
            </td>
            <td class="right">Rp {{ "{:,}".format(subtotal) }}</td>
            <td class="actions">
              <!-- Hapus 1 item -->
              <!-- CATATAN: idealnya form hapus tidak di-nesting di form update; 
                   tapi tetap jalan di banyak browser. Kalau mau rapi, pindahkan form hapus ke luar form update. -->
              <form id="del-{{ key }}" action="{{ url_for('hapus_item_keranjang', pid=key) }}" method="post" style="display:inline;"></form>
              <button type="submit"
                      class="btn btn-danger"
                      form="del-{{ key }}"
                      onclick="return confirm('Hapus item ini?')">
                üóë Hapus
              </button>
            </td>
          </tr>
        {% endfor %}
      </tbody>
      <tfoot>
        <tr>
          <th colspan="3" class="right">Total</th>
          <th class="right">Rp {{ "{:,}".format(total) }}</th>
          <th></th>
        </tr>
      </tfoot>
    </table>
  </form>

  <!-- Footer Actions -->
  <div class="footer-actions">
    <!-- BATALKAN SEMUA -->
    <form action="{{ url_for('keranjang_clear') }}" method="post" onsubmit="return confirm('Batalkan & kosongkan semua item dari keranjang?')">
      <button type="submit" class="btn btn-muted">‚õî Batalkan Keranjang</button>
    </form>

    <!-- Potensi Keuntungan -->
    <button type="button" class="btn btn-success" onclick="openProfit()">üí° Potensi Keuntungan</button>

    <!-- Checkout -->
    <a href="{{ url_for('pembayaran') }}" class="btn btn-success" onclick="return confirm('Lanjut ke pembayaran?')">‚úÖ Checkout</a>
  </div>

  {% else %}
    <p>Keranjang masih kosong. Silakan pilih produk di halaman produk.</p>
  {% endif %}

  {% if error %}
    <p style="color:#dc3545; margin-top:10px;">{{ error }}</p>
  {% endif %}
</div>

<!-- Modal UBAH HARGA -->
<div id="priceBackdrop" class="modal-backdrop" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="priceTitle">
    <div class="modal-head">
      <div id="priceTitle" style="font-weight:800;">Ubah Harga</div>
      <button class="btn btn-muted" onclick="closePriceModal()">Tutup</button>
    </div>
    <form id="priceForm" method="post" action="{{ url_for('keranjang_update_price') }}">
      <div class="modal-body">
        <div style="margin-bottom:8px;color:#6b7280;">Produk: <strong id="priceNama"></strong></div>
        <input type="hidden" name="key" id="priceKey">
        <label for="priceInput" style="display:block; font-size:13px; color:#6b7280; margin-bottom:6px;">Harga Baru (Rp)</label>
        <input id="priceInput" name="price" type="number" min="0" value="0" style="width:100%; padding:8px; border:1px solid #e5e7eb; border-radius:8px;">
      </div>
      <div class="modal-foot">
        <button type="button" class="btn btn-muted" onclick="closePriceModal()">Batal</button>
        <button type="submit" class="btn btn-primary">Simpan</button>
      </div>
    </form>
  </div>
</div>

<!-- Modal Potensi Keuntungan -->
<div id="profitBackdrop" class="modal-backdrop" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true">
    <div class="modal-head">
      <div style="font-weight:800;">Potensi Keuntungan</div>
      <button class="btn btn-muted" onclick="closeProfit()">Tutup</button>
    </div>
    <div class="modal-body" id="profitBody">
      <!-- konten diisi dari JS -->
    </div>
  </div>
</div>
  
<script>
  // ====== Auto-save QTY (tanpa tombol update) ======
  let qtyTimer = null;
  function autoSaveQty(){
    clearTimeout(qtyTimer);
    qtyTimer = setTimeout(()=>{
      const form = document.getElementById('updateForm');
      const fd = new FormData(form);
      fetch(form.action, { method:'POST', body: fd })
        .then(()=> location.reload())
        .catch(()=> form.submit());
    }, 350);
  }

  // ====== Modal UBAH HARGA ======
  function openPriceModal(key, harga, nama){
    document.getElementById('priceKey').value   = key;
    document.getElementById('priceInput').value = harga || 0;
    document.getElementById('priceNama').textContent = nama || '';
    const bd = document.getElementById('priceBackdrop');
    bd.classList.add('show');
    bd.setAttribute('aria-hidden','false');
    document.body.style.overflow = 'hidden';
    setTimeout(()=> document.getElementById('priceInput').focus(), 50);
  }
  function closePriceModal(){
    const bd = document.getElementById('priceBackdrop');
    bd.classList.remove('show');
    bd.setAttribute('aria-hidden','true');
    document.body.style.overflow = '';
  }

  // ====== Potensi Keuntungan = (Harga ‚àí HPP) √ó Qty ======
  function fmt(n){ try{ return 'Rp ' + (n||0).toLocaleString('id-ID'); }catch(e){ return 'Rp ' + n; } }

  function openProfit(){
    const rows = [...document.querySelectorAll('tbody tr')];
    let totalProfit = 0;
    let html = `

    `;

    rows.forEach(tr => {
      const nama  = tr.querySelector('td strong')?.textContent || '';
      const priceInput = tr.querySelector('input[name="price[]"]');
      const qtyInput   = tr.querySelector('input[name="qty[]"]');
      const hppInput   = tr.querySelector('.hpp-val');

      const harga = parseInt((priceInput?.value || '0').replace(/[^\d]/g,''), 10) || 0;
      const qty   = parseInt(qtyInput?.value || '0', 10) || 0;
      const hpp   = parseInt(hppInput?.value || '0', 10) || 0;

      const profitPerItem = (harga - hpp);
      const lineProfit    = profitPerItem * qty;

      totalProfit += lineProfit;

      if(nama && qty>0){
        html += `
          <div style="display:flex; justify-content:space-between; gap:12px;">
            <span>
              {{- "" -}}
              <strong>${nama}</strong> √ó ${qty}
              <span style="color:#6b7280;">(${fmt(harga)})</span>
            </span>
            <strong>${fmt(lineProfit)}</strong>
          </div>
        `;
      }
    });

    html += `
      <hr style="border:none; border-top:1px solid #eee;">
      <div style="display:flex; justify-content:space-between;">
        <span>Total Potensi Keuntungan</span><strong>${fmt(totalProfit)}</strong>
      </div>
      </div>
    `;

    document.getElementById('profitBody').innerHTML = html;
    const bd = document.getElementById('profitBackdrop');
    bd.classList.add('show');
    bd.setAttribute('aria-hidden','false');
    document.body.style.overflow = 'hidden';
  }

  function closeProfit(){
    document.getElementById('profitBackdrop').classList.remove('show');
    document.getElementById('profitBackdrop').setAttribute('aria-hidden','true');
    document.body.style.overflow = '';
  }
</script>
{% endblock %}