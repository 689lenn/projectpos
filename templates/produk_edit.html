{% extends "base.html" %}
{% block title %}Edit Produk{% endblock %}

{% block head %}
<style>
  .wrap{max-width: 920px; margin:0 auto;}
  .card{background:#fff; border:1px solid #e6e8f0; border-radius:12px; padding:16px;}
  .grid{display:grid; grid-template-columns:1fr 1fr; gap:14px;}
  @media (max-width: 720px){ .grid{grid-template-columns:1fr;} }
  label{display:block; font-size:13px; color:#6b7280; margin-bottom:6px; font-weight:600;}
  .control{width:100%; padding:10px 12px; border:1px solid #e6e8f0; border-radius:10px; outline:none;}
  .control:focus{border-color:#cfe3ff; box-shadow:0 0 0 4px rgba(0,123,255,.2);}
  .actions{display:flex; justify-content:flex-end; gap:10px; margin-top:12px;}
  .btn{border:none; border-radius:10px; padding:10px 14px; font-weight:800; cursor:pointer; color:#fff;}
  .btn-primary{background:#007bff;}
  .btn-muted{background:#6b7280;}
  .toggle-row{display:flex; gap:8px; align-items:center; margin:10px 0;}
  .resep-box{display:none; margin-top:10px; border:1px dashed #cfe3ff; background:#f7fbff; border-radius:12px; padding:12px;}
  .resep-box.show{display:block;}
  table{width:100%; border-collapse:collapse;}
  th,td{border-bottom:1px solid #edf0f5; padding:8px;}
  th{background:#f9fafb; text-align:left; font-size:13px; color:#6b7280;}
  .add-row{background:#0ea5e9; color:#fff; border:none; border-radius:10px; padding:8px 12px; font-weight:800; cursor:pointer;}
  .del-row{background:#ef4444; color:#fff; border:none; border-radius:8px; padding:6px 10px; cursor:pointer;}
  .prev{margin-top:8px; font-size:12px; color:#6b7280;}
  .hint{font-size:12px; color:#6b7280; margin-top:4px;}
</style>
{% endblock %}

{% block content %}
<div class="wrap">
  <h1>Edit Produk</h1>
  <div class="card">
    <form method="post" enctype="multipart/form-data">
      <div class="grid">
        <div>
          <label>Nama</label>
          <input class="control" name="nama" value="{{ produk.nama }}" required>

          <label style="margin-top:10px;">Harga (Rp)</label>
          <input class="control" name="harga" type="number" min="0" value="{{ produk.harga }}" required>

          <label style="margin-top:10px;">HPP (Rp)</label>
          <input class="control" name="hpp" type="number" min="0" value="{{ produk.hpp or 0 }}" required>

          <label style="margin-top:10px;">Stok</label>
          <input class="control" name="stok" type="number" min="-999999" value="{{ produk.stok }}" required>
        </div>
        <div>
          <label>Kategori</label>
          <select class="control" name="kategori_id">
            <option value="">(Tanpa kategori)</option>
            {% for k in kategori %}
              <option value="{{ k.id }}" {% if produk.kategori_id == k.id %}selected{% endif %}>{{ k.nama }}</option>
            {% endfor %}
          </select>

          <label style="margin-top:10px;">Foto (opsional)</label>
          <input class="control" type="file" name="foto" accept="image/*">
          {% if produk.foto %}
            <div class="prev">Foto saat ini: {{ produk.foto }}</div>
          {% endif %}

          <!-- Toggle Manufaktur -->
          <div class="toggle-row">
            <input id="is_manu" type="checkbox" name="is_manufaktur" value="1" {% if produk.is_manufaktur %}checked{% endif %} />
            <label for="is_manu" style="margin:0;">Produk Manufaktur (punya resep bahan)</label>
          </div>
        </div>
      </div>

      <!-- RESEP -->
      <div id="resepBox" class="resep-box {% if produk.is_manufaktur %}show{% endif %}" aria-hidden="{{ 'false' if produk.is_manufaktur else 'true' }}">
        <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:8px;">
          <strong>Resep Bahan</strong>
          <button type="button" class="add-row" onclick="addRow()">+ Tambah Bahan</button>
        </div>
        <div class="hint">Isi <em>Jumlah per Unit</em> dengan desimal jika perlu (contoh: <strong>1</strong> atau <strong>0,5</strong>). Sistem menerima titik atau koma.</div>
        <table id="resepTbl">
          <thead>
            <tr>
              <th style="width:55%;">Bahan</th>
              <th style="width:35%;">Jumlah per Unit</th>
              <th style="width:10%;">Aksi</th>
            </tr>
          </thead>
          <tbody>
            {% if produk.is_manufaktur and produk.resep_bahan %}
              {% for r in produk.resep_bahan %}
              <tr>
                <td>
                  <select name="bahan_id[]" class="control resep-required">
                    <option value="">- Pilih bahan -</option>
                    {% for p in semua_produk %}
                      <option value="{{ p.id }}" {% if p.id == r.bahan_id %}selected{% endif %}>{{ p.nama }} (stok: {{ p.stok }})</option>
                    {% endfor %}
                  </select>
                </td>
                <td>
                  <input class="control resep-required"
                         name="bahan_qty[]"
                         type="text"
                         inputmode="decimal"
                         placeholder="cth: 1 atau 0,5"
                         value="{{ ('%.4f' % (r.qty|float)).rstrip('0').rstrip('.') }}">
                </td>
                <td><button type="button" class="del-row" onclick="this.closest('tr').remove()">Hapus</button></td>
              </tr>
              {% endfor %}
            {% endif %}
          </tbody>
        </table>
      </div>

      <div class="actions">
        <a class="btn btn-muted" href="{{ url_for('produk_list') }}">Batal</a>
        <button class="btn btn-primary" type="submit">Simpan</button>
      </div>
    </form>
  </div>
</div>

<script>
  const chk = document.getElementById('is_manu');
  const box = document.getElementById('resepBox');
  const tbody = document.querySelector('#resepTbl tbody');

  function setRequiredInBox(enabled){
    // Toggle required hanya saat manufaktur aktif
    const fields = box.querySelectorAll('.resep-required');
    fields.forEach(el => {
      if (enabled) el.setAttribute('required','required');
      else el.removeAttribute('required');
    });
  }

  function clearRows(){
    tbody.innerHTML = '';
  }

  function addRow(){
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>
        <select name="bahan_id[]" class="control resep-required">
          <option value="">- Pilih bahan -</option>
          {% for p in semua_produk %}
            <option value="{{ p.id }}">{{ p.nama }} (stok: {{ p.stok }})</option>
          {% endfor %}
        </select>
      </td>
      <td>
        <input class="control resep-required"
               name="bahan_qty[]"
               type="text"
               inputmode="decimal"
               placeholder="cth: 1 atau 0,5">
      </td>
      <td><button type="button" class="del-row" onclick="this.closest('tr').remove()">Hapus</button></td>
    `;
    tbody.appendChild(tr);
    // pastikan required aktif jika manufaktur dicentang
    if (chk.checked) setRequiredInBox(true);
  }

  // Inisialisasi status required sesuai checkbox saat halaman dibuka
  (function initManu(){
    if (chk.checked){
      box.classList.add('show');
      box.setAttribute('aria-hidden', 'false');
      setRequiredInBox(true);
    } else {
      box.classList.remove('show');
      box.setAttribute('aria-hidden', 'true');
      setRequiredInBox(false);
      clearRows();
    }
  })();

  chk.addEventListener('change', () => {
    if(chk.checked){
      box.classList.add('show');
      box.setAttribute('aria-hidden','false');
      setRequiredInBox(true);
      if (tbody.children.length === 0) addRow(); // bantu user isi satu baris awal
    } else {
      box.classList.remove('show');
      box.setAttribute('aria-hidden','true');
      setRequiredInBox(false);
      clearRows();
    }
  });
</script>
{% endblock %}