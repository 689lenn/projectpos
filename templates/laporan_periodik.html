{% extends "base.html" %}
{% block title %}Laporan Periodik{% endblock %}

{% block head %}
<style>
  .wrap { display:grid; grid-template-columns: 280px 1fr; gap:16px; }
  @media (max-width: 992px){ .wrap{ grid-template-columns:1fr; } }

  .panel { background:#fff; border:1px solid #e6e8f0; border-radius:12px; padding:12px; box-shadow:0 8px 18px rgba(0,0,0,.06); }

  .label{ font-size:12px; color:#6b7280; display:block; margin-bottom:6px; font-weight:700; }
  .control{ width:100%; padding:10px 12px; border:1px solid #e5e7eb; border-radius:10px; outline:none; background:#fff; }
  .control:focus{ border-color:#cfe3ff; box-shadow:0 0 0 4px rgba(0,123,255,.25); }

  .btn { border:none; border-radius:10px; padding:10px 12px; cursor:pointer; font-weight:700; color:#fff; background:#007bff; }
  .btn:hover{ background:#0064cf; }
  .btn-muted{ background:#6c757d; text-decoration:none; display:inline-flex; align-items:center; }
  .btn-muted:hover{ filter: brightness(.95); }

  .grid-2{ display:grid; grid-template-columns:1fr 1fr; gap:10px; }
  .actions{ display:flex; gap:8px; flex-wrap:wrap; margin-top:10px; }

  .cards{ display:grid; grid-template-columns: repeat(5, 1fr); gap:10px; margin-bottom:10px; }
  @media (max-width: 1200px){ .cards{ grid-template-columns: repeat(3, 1fr); } }
  @media (max-width: 720px){ .cards{ grid-template-columns: repeat(2, 1fr); } }

  .card {
    background:#fafbff; border:1px solid #e9ecf4; border-radius:12px; padding:12px;
  }
  .card .t{ font-size:12px; color:#6b7280; margin-bottom:4px; }
  .card .v{ font-size:18px; font-weight:800; }

  table { width:100%; border-collapse: collapse; background:#fff; }
  th, td { border:1px solid #e6e8f0; padding:8px; text-align:left; }
  th { background:#f6f8fb; }
  .right{ text-align:right; }
  .badge {
    display:inline-block; padding:4px 8px; border-radius:999px; font-size:12px; font-weight:800;
  }
  .badge.lunas{ background:#eafff3; color:#0a7a3b; border:1px solid #c7f0d7; }
  .badge.hutang{ background:#fff4f4; color:#b42318; border:1px solid #ffd1d1; }
</style>
{% endblock %}

{% block content %}
<h1>Laporan Periodik</h1>

<div class="wrap">
  <!-- Panel Filter -->
  <aside class="panel">
    <form method="get" action="{{ url_for('laporan_periodik') }}">
      <div class="grid-2">
        <div>
          <label class="label" for="start">Dari Tanggal</label>
          <input id="start" name="start" type="date" class="control" value="{{ start }}">
        </div>
        <div>
          <label class="label" for="end">Sampai Tanggal</label>
          <input id="end" name="end" type="date" class="control" value="{{ end }}">
        </div>
      </div>

      <div style="margin-top:10px;">
        <label class="label" for="status">Status</label>
        <select id="status" name="status" class="control">
          <option value="all"   {% if status=='all' %}selected{% endif %}>Semua</option>
          <option value="lunas" {% if status=='lunas' %}selected{% endif %}>Lunas</option>
          <option value="hutang"{% if status=='hutang' %}selected{% endif %}>Hutang</option>
        </select>
      </div>

      <div class="actions">
        <button class="btn" type="submit">ðŸ”Ž Tampilkan</button>
        <a class="btn btn-muted" href="{{ url_for('laporan_periodik') }}">â†» Reset</a>
      </div>
    </form>
  </aside>

  <!-- Panel Konten -->
  <section>
    <!-- Ringkasan -->
    <div class="cards">
      <div class="card">
        <div class="t">Total Transaksi</div>
        <div class="v">{{ total_trx or 0 }}</div>
      </div>
      <div class="card">
        <div class="t">Total Penjualan</div>
        <div class="v">{{ rupiah(total_penjualan or 0) }}</div>
      </div>
      <div class="card">
        <div class="t">Total Dibayar</div>
        <div class="v">{{ rupiah(total_dibayar or 0) }}</div>
      </div>
      <div class="card">
        <div class="t">Total Sisa (Hutang)</div>
        <div class="v">{{ rupiah(total_sisa or 0) }}</div>
      </div>
      <div class="card">
        <div class="t">Rata-rata Ticket</div>
        <div class="v">{{ rupiah((avg_ticket or 0)|round|int) }}</div>
      </div>
    </div>

    <div class="cards" style="margin-top:10px;">
      <div class="card">
        <div class="t">Total Item Terjual</div>
        <div class="v">{{ total_item_terjual or 0 }}</div>
      </div>
      <div class="card">
        <div class="t">HPP (approx)</div>
        <div class="v">{{ rupiah(total_hpp_cost or 0) }}</div>
      </div>
      <div class="card">
        <div class="t">Laba Periode (approx)</div>
        <div class="v">{{ rupiah(total_laba or 0) }}</div>
      </div>
    </div>

    <!-- Drill-down: Daftar transaksi -->
    <div class="panel" style="padding:0; margin-top:10px;">
      <table>
        <thead>
          <tr>
            <th style="width:80px;">ID</th>
            <th style="width:120px;">Tanggal</th>
            <th>Pelanggan</th>
            <th class="right">Total</th>
            <th class="right">Bayar</th>
            <th class="right">Sisa</th>
            <th style="width:100px;">Status</th>
            <th style="width:120px;">Aksi</th>
          </tr>
        </thead>
        <tbody>
          {% for r in drill_rows %}
          <tr>
            <td>#{{ r.id }}</td>
            <td>{{ r.tanggal }}</td>
            <td>{{ r.customer }}</td>
            <td class="right">{{ rupiah(r.total) }}</td>
            <td class="right">{{ rupiah(r.bayar) }}</td>
            <td class="right">{{ rupiah(r.sisa) }}</td>
            <td>
              {% if r.status == 'HUTANG' %}
                <span class="badge hutang">HUTANG</span>
              {% else %}
                <span class="badge lunas">LUNAS</span>
              {% endif %}
            </td>
            <td>
              <a class="btn btn-muted" href="{{ url_for('transaksi_detail', id=r.id) }}">Lihat</a>
            </td>
          </tr>
          {% else %}
          <tr>
            <td colspan="8" style="text-align:center; color:#6b7280;">Belum ada transaksi pada periode & filter ini.</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <div style="margin-top:8px; color:#6b7280;">
      * Klik <strong>Lihat</strong> untuk membuka <em>Detail Transaksi</em> (ada tombol <em>Cetak</em> di sana).
    </div>
  </section>
</div>
{% endblock %}